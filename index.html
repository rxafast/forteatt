<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Forte College System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- 1. UI HELPERS (Runs Immediately) -->
    <script>
        window.onerror = function(msg, url, line) {
            const el = document.getElementById('error-console');
            if(el) {
                el.style.display = 'block';
                el.innerHTML += `<div>[ERROR] ${msg} (Line ${line})</div>`;
            }
            return false;
        };

        window.safeClassList = function(id, action, ...args) {
            const el = document.getElementById(id);
            if (el) {
                if (action === 'add') el.classList.add(args[0]);
                if (action === 'remove') el.classList.remove(args[0]);
                if (action === 'replace') el.classList.replace(args[0], args[1]);
            }
        };

        window.showToast = function(msg) {
            const t = document.getElementById('toast');
            if(t) {
                t.textContent = msg;
                t.style.transform = "translate(-50%, 20px)";
                setTimeout(() => t.style.transform = "translate(-50%, -150%)", 3000);
            }
        };

        window.toggleAddModal = function() {
            const el = document.getElementById('add-modal');
            if(el) el.classList.toggle('hidden');
        };

        window.showLoginTab = function(tab) {
            const tBtn = document.getElementById('tab-teacher');
            const aBtn = document.getElementById('tab-admin');
            const tForm = document.getElementById('form-teacher');
            const aForm = document.getElementById('form-admin');

            if(tab === 'teacher') {
                if(tBtn) { tBtn.classList.add('text-blue-600', 'border-blue-600'); tBtn.classList.remove('text-gray-400'); }
                if(aBtn) { aBtn.classList.remove('text-blue-600', 'border-blue-600'); aBtn.classList.add('text-gray-400'); }
                if(tForm) tForm.classList.remove('hidden'); 
                if(aForm) aForm.classList.add('hidden');
            } else {
                if(aBtn) { aBtn.classList.add('text-blue-600', 'border-blue-600'); aBtn.classList.remove('text-gray-400'); }
                if(tBtn) { tBtn.classList.remove('text-blue-600', 'border-blue-600'); tBtn.classList.add('text-gray-400'); }
                if(aForm) aForm.classList.remove('hidden'); 
                if(tForm) tForm.classList.add('hidden');
            }
        };
    </script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        button { touch-action: manipulation; }
        .subject-badge { font-size: 0.7rem; cursor: pointer; user-select: none; transition: all 0.15s; display: inline-flex; align-items: center; justify-content: center; min-width: 40px; }
        .status-P { background-color: #d1fae5; color: #065f46; border: 1px solid #065f46; }
        .status-A { background-color: #fee2e2; color: #991b1b; border: 1px solid #991b1b; }
        .status-L { background-color: #fef3c7; color: #92400e; border: 1px solid #92400e; }
        .status-- { background-color: #e5e7eb; color: #9ca3af; border: 1px dashed #d1d5db; cursor: not-allowed; } 
        .table-container::-webkit-scrollbar { height: 6px; width: 6px; }
        .table-container::-webkit-scrollbar-track { background: #f1f1f1; }
        .table-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .sticky-col { position: sticky; left: 0; background-color: white; z-index: 20; border-right: 1px solid #e5e7eb; }
        th.sticky-col { background-color: #f3f4f6; z-index: 30; }
        .toggle-btn { font-size: 0.75rem; padding: 4px 8px; border-radius: 9999px; border: 1px solid; transition: all 0.2s; cursor: pointer; }
        .toggle-active { background-color: #ebf8ff; border-color: #3182ce; color: #2c5282; font-weight: 600; }
        .toggle-inactive { background-color: #f7fafc; border-color: #cbd5e0; color: #a0aec0; text-decoration: line-through; }
        #error-console { position: fixed; bottom: 0; left: 0; right: 0; background: #fee2e2; color: #991b1b; padding: 10px; font-size: 12px; font-family: monospace; display: none; z-index: 10000; border-top: 2px solid #ef4444; max-height: 200px; overflow: auto; }
        
        /* Admin Dashboard Cards */
        .dash-card { background: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s; border: 1px solid #e5e7eb; }
        .dash-card:hover { transform: translateY(-2px); border-color: #3b82f6; }
        .dash-icon { font-size: 2rem; margin-bottom: 0.5rem; color: #3b82f6; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800">

    <div id="error-console"></div>
    <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-gray-800/90 text-white px-6 py-3 rounded-full shadow-xl translate-y-[-150%] transition-transform duration-300 z-50 text-sm font-medium backdrop-blur-sm pointer-events-none">Action Saved</div>

    <!-- LOGIN OVERLAY -->
    <div id="login-overlay" class="fixed inset-0 bg-blue-900 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-sm overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-6 text-center bg-blue-50 border-b relative">
                <i class="fas fa-university text-4xl text-blue-800 mb-2"></i>
                <h1 class="text-xl font-bold text-gray-800">Forte College</h1>
                <p id="sys-status" class="text-xs text-orange-500 font-bold mt-1">Connecting...</p>
                <div class="flex justify-center gap-4 mt-4 text-sm font-medium">
                    <button onclick="window.showLoginTab('teacher')" id="tab-teacher" class="text-blue-600 border-b-2 border-blue-600 pb-1 transition">Teacher</button>
                    <button onclick="window.showLoginTab('admin')" id="tab-admin" class="text-gray-400 hover:text-gray-600 pb-1 transition">Admin</button>
                </div>
            </div>
            
            <!-- Teacher Form -->
            <div id="form-teacher" class="p-6 space-y-4">
                <input type="text" id="login-teacher-email" class="w-full border p-3 rounded text-sm" placeholder="Username / Email">
                <input type="password" id="login-teacher-pass" class="w-full border p-3 rounded text-sm" placeholder="Password">
                <button onclick="window.handleLogin('teacher')" id="btn-login-teacher" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded shadow transition">Login</button>
                <div id="class-select-area" class="hidden pt-4 border-t">
                    <label class="block text-xs font-bold text-gray-600 mb-1">Select Class</label>
                    <select id="login-class-select" class="w-full border p-3 rounded text-sm mb-3"></select>
                    <button onclick="window.enterClass()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded shadow">Enter Class</button>
                </div>
            </div>

            <!-- Admin Form -->
            <div id="form-admin" class="p-6 space-y-4 hidden">
                <input type="email" id="login-admin-email" class="w-full border p-3 rounded text-sm" placeholder="admin@forte.com">
                <input type="password" id="login-admin-pass" class="w-full border p-3 rounded text-sm" placeholder="Password">
                <button onclick="window.handleLogin('admin')" id="btn-login-admin" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 rounded shadow transition">Login as Admin</button>
                <div class="text-center">
                    <button onclick="window.forgotPassword()" class="text-xs text-blue-500 hover:underline">Forgot Password?</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="view-admin" class="fixed inset-0 bg-gray-50 z-40 hidden flex flex-col overflow-hidden">
        <header class="bg-gray-900 text-white p-4 shadow flex justify-between items-center z-10">
            <div class="flex items-center gap-3">
                <i class="fas fa-chart-pie text-xl text-blue-400"></i>
                <div>
                    <h1 class="font-bold text-lg leading-tight">Admin Command</h1>
                    <p class="text-[10px] text-gray-400">Forte College System</p>
                </div>
            </div>
            <button onclick="window.logout()" class="bg-red-600 hover:bg-red-700 px-3 py-1.5 rounded text-xs font-bold transition">Logout</button>
        </header>
        
        <div class="flex-1 overflow-y-auto p-4 max-w-5xl mx-auto w-full">
            
            <!-- SECTION: DASHBOARD (Default View) -->
            <div id="admin-section-dashboard" class="space-y-6">
                <!-- Stats Row -->
                <div class="grid grid-cols-3 gap-4">
                    <div class="bg-white p-4 rounded shadow border-l-4 border-blue-500 text-center">
                        <p class="text-xs text-gray-500 font-bold uppercase">Teachers</p>
                        <p class="text-2xl font-bold text-gray-800" id="stat-teachers">0</p>
                    </div>
                    <div class="bg-white p-4 rounded shadow border-l-4 border-green-500 text-center">
                        <p class="text-xs text-gray-500 font-bold uppercase">Classes</p>
                        <p class="text-2xl font-bold text-gray-800" id="stat-classes">0</p>
                    </div>
                    <div class="bg-white p-4 rounded shadow border-l-4 border-purple-500 text-center">
                        <p class="text-xs text-gray-500 font-bold uppercase">Subjects</p>
                        <p class="text-2xl font-bold text-gray-800" id="stat-subjects">0</p>
                    </div>
                </div>

                <!-- Live Attendance Overview -->
                <div>
                    <div class="flex justify-between items-center mb-3 border-b pb-1">
                        <h2 class="text-sm font-bold text-gray-600 uppercase">Live Status Overview</h2>
                        <div class="flex items-center gap-2">
                            <input type="date" id="admin-live-date" class="border rounded p-1 text-xs" onchange="window.initAdminLiveDashboard()">
                            <button onclick="window.initAdminLiveDashboard()" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100" title="Refresh"><i class="fas fa-sync-alt"></i></button>
                        </div>
                    </div>
                    <div class="bg-white rounded shadow overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-100 text-xs uppercase text-gray-500">
                                <tr>
                                    <th class="p-3">Class Name</th>
                                    <th class="p-3 text-center text-green-600">Full Present</th>
                                    <th class="p-3 text-center text-orange-600">Short Leave</th>
                                    <th class="p-3 text-center text-red-600">Absent</th>
                                    <th class="p-3 text-center text-yellow-600">Leave</th>
                                </tr>
                            </thead>
                            <tbody id="admin-live-table">
                                <tr><td colspan="5" class="p-4 text-center text-gray-400 italic">Connecting to live feeds...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Menu Grid -->
                <h2 class="text-sm font-bold text-gray-500 uppercase mt-4 mb-4 border-b pb-2">Management Console</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div onclick="window.switchAdminSection('teachers')" class="dash-card flex flex-col items-center justify-center text-center">
                        <i class="fas fa-chalkboard-teacher dash-icon"></i> <span class="font-bold text-gray-700">Teachers</span>
                    </div>
                    <div onclick="window.switchAdminSection('classes')" class="dash-card flex flex-col items-center justify-center text-center">
                        <i class="fas fa-layer-group dash-icon text-green-500"></i> <span class="font-bold text-gray-700">Classes</span>
                    </div>
                    <div onclick="window.switchAdminSection('subjects')" class="dash-card flex flex-col items-center justify-center text-center">
                        <i class="fas fa-book-open dash-icon text-purple-500"></i> <span class="font-bold text-gray-700">Subjects</span>
                    </div>
                    <div onclick="window.switchAdminSection('reports')" class="dash-card flex flex-col items-center justify-center text-center">
                        <i class="fas fa-file-alt dash-icon text-orange-500"></i> <span class="font-bold text-gray-700">Reports</span>
                    </div>
                </div>
            </div>

            <!-- SECTION: TEACHERS -->
            <div id="admin-section-teachers" class="hidden space-y-4">
                <div class="flex justify-between items-center border-b pb-2">
                    <h2 class="text-xl font-bold text-gray-800"><i class="fas fa-chalkboard-teacher mr-2 text-blue-600"></i>Teachers</h2>
                    <button onclick="window.switchAdminSection('dashboard')" class="text-sm text-gray-500 hover:text-gray-800">Back</button>
                </div>
                
                <!-- Add Teacher Form -->
                <div class="bg-white p-4 rounded shadow">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 mb-2">
                        <input type="text" id="new-teacher-name" placeholder="Name (e.g. Sir Ali)" class="border p-2 rounded text-sm">
                        <input type="text" id="new-teacher-email" placeholder="Login Email" class="border p-2 rounded text-sm">
                        <input type="text" id="new-teacher-pass" placeholder="Password" class="border p-2 rounded text-sm">
                    </div>
                    <button onclick="window.adminAddTeacher()" class="w-full bg-blue-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-blue-700"><i class="fas fa-plus mr-1"></i> Register New Teacher</button>
                </div>

                <div id="admin-teacher-list" class="space-y-3"></div>
            </div>

            <!-- SECTION: CLASSES -->
            <div id="admin-section-classes" class="hidden space-y-4">
                <div class="flex justify-between items-center border-b pb-2">
                    <h2 class="text-xl font-bold text-gray-800"><i class="fas fa-layer-group mr-2 text-green-600"></i>Classes</h2>
                    <button onclick="window.switchAdminSection('dashboard')" class="text-sm text-gray-500 hover:text-gray-800">Back</button>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="new-class-name" placeholder="New Class ID (e.g. ICS-A)" class="flex-1 border p-2 rounded text-sm uppercase">
                    <button onclick="window.adminCreateClass()" class="bg-green-600 text-white px-4 rounded text-sm hover:bg-green-700">Create</button>
                </div>
                <div id="admin-class-list" class="space-y-2"></div>
            </div>

            <!-- SECTION: SUBJECTS -->
            <div id="admin-section-subjects" class="hidden space-y-4">
                <div class="flex justify-between items-center border-b pb-2">
                    <h2 class="text-xl font-bold text-gray-800"><i class="fas fa-book-open mr-2 text-purple-600"></i>Subjects</h2>
                    <button onclick="window.switchAdminSection('dashboard')" class="text-sm text-gray-500 hover:text-gray-800">Back</button>
                </div>
                <div class="bg-white p-4 rounded shadow border border-gray-200">
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">New Global Subject</label>
                        <div class="flex gap-2">
                            <input type="text" id="new-subject-name" placeholder="Code (e.g. BIO)" class="flex-1 border p-2 rounded text-sm uppercase">
                            <button onclick="window.adminAddGlobalSubject()" class="bg-purple-600 text-white px-4 rounded text-sm hover:bg-purple-700 font-bold">Add Global</button>
                        </div>
                    </div>
                </div>
                <!-- Dynamic Subject List Container -->
                <div id="admin-subject-list" class="space-y-4"></div>
            </div>

            <!-- SECTION: REPORTS -->
            <div id="admin-section-reports" class="hidden space-y-4">
                <div class="flex justify-between items-center border-b pb-2">
                    <h2 class="text-xl font-bold text-gray-800"><i class="fas fa-file-alt mr-2 text-orange-600"></i>Master Reports</h2>
                    <button onclick="window.switchAdminSection('dashboard')" class="text-sm text-gray-500 hover:text-gray-800">Back</button>
                </div>
                
                <!-- View/Manage Class Report -->
                <div class="bg-white p-4 rounded shadow border border-gray-200 mb-4">
                    <h3 class="font-bold text-gray-700 mb-2">View & Manage Class Attendance</h3>
                    <p class="text-xs text-gray-500 mb-3">Open the full attendance sheet for editing or viewing.</p>
                    <div class="flex gap-2">
                        <select id="report-class-select" class="flex-1 border p-2 rounded text-sm"></select>
                        <button onclick="window.adminViewClass(document.getElementById('report-class-select').value)" class="bg-orange-600 text-white px-4 py-1 rounded text-sm hover:bg-orange-700">Open Class</button>
                    </div>
                </div>
                
                <!-- Direct CSV Download -->
                <div class="bg-white p-4 rounded shadow border border-gray-200 mb-4">
                    <h3 class="font-bold text-gray-700 mb-2">Monthly Class Report (CSV)</h3>
                    <p class="text-xs text-gray-500 mb-3">Download full attendance sheet for a class.</p>
                    <div class="flex gap-2">
                        <select id="admin-rep-class" class="flex-1 border p-2 rounded text-sm"></select>
                        <input type="month" id="admin-rep-month" class="border p-2 rounded text-sm">
                        <button onclick="window.adminDownloadMonthlyReport()" class="bg-blue-600 text-white px-4 py-1 rounded text-sm hover:bg-blue-700">Download</button>
                    </div>
                </div>

                <!-- Daily Summary -->
                <div class="bg-white p-4 rounded shadow border border-gray-200">
                    <h3 class="font-bold text-gray-700 mb-2">Daily College Summary (CSV)</h3>
                    <p class="text-xs text-gray-500 mb-3">Overview of all classes for a specific date.</p>
                    <div class="flex gap-2">
                        <input type="date" id="admin-rep-date" class="flex-1 border p-2 rounded text-sm">
                        <button onclick="window.adminDownloadDailySummary()" class="bg-green-600 text-white px-4 py-1 rounded text-sm hover:bg-green-700">Download</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app" class="flex flex-col h-full hidden">
        <header class="bg-blue-800 text-white shadow-md z-30 shrink-0">
            <div class="bg-blue-900 flex justify-between items-center px-4 py-2 border-b border-blue-700">
                <div class="text-xs sm:text-sm font-bold tracking-widest uppercase text-blue-100">Forte College</div>
                <div class="flex items-center gap-2">
                    <span id="admin-badge" class="hidden text-[8px] bg-red-600 px-1 rounded font-bold">ADMIN</span>
                    <button id="btn-back-dashboard" onclick="window.backToDashboard()" class="hidden text-[10px] bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded ml-1 border border-gray-500">Back</button>
                    <span id="header-class-name" class="text-xs font-mono bg-blue-800 px-2 py-0.5 rounded border border-blue-600 ml-1">...</span>
                    <button onclick="window.logout()" class="text-[10px] hover:text-red-300 ml-2"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
            <div class="p-3 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="relative group cursor-pointer w-10 h-10 rounded-full bg-white/10 border border-white/20 overflow-hidden flex items-center justify-center shrink-0" onclick="document.getElementById('logo-upload').click()">
                        <img id="app-logo" src="" class="w-full h-full object-cover hidden" alt="Logo">
                        <i id="default-logo-icon" class="fas fa-university text-xl"></i>
                        <input type="file" id="logo-upload" accept="image/*" class="hidden" onchange="window.uploadLogo(this)">
                    </div>
                    <div><h1 class="text-lg font-bold leading-tight">Attendance</h1><p id="teacher-display" class="text-[10px] text-blue-200">Welcome</p></div>
                </div>
                <button onclick="window.toggleAddModal()" class="text-xs bg-blue-700 hover:bg-blue-600 px-3 py-1.5 rounded flex items-center gap-2 border border-blue-600"><i class="fas fa-plus"></i> <span class="hidden sm:inline">Add Student</span></button>
            </div>
            <nav class="flex text-sm bg-blue-900 overflow-x-auto">
                <button onclick="window.switchTab('daily')" id="btn-daily" class="flex-1 py-3 px-2 text-center border-b-4 border-blue-500 bg-blue-800 font-medium">Daily Entry</button>
                <button onclick="window.switchTab('report')" id="btn-report" class="flex-1 py-3 px-2 text-center border-b-4 border-transparent hover:bg-blue-800 text-blue-100 font-medium">Report</button>
                <button onclick="window.switchTab('students')" id="btn-students" class="flex-1 py-3 px-2 text-center border-b-4 border-transparent hover:bg-blue-800 text-blue-100 font-medium">Students</button>
            </nav>
        </header>

        <main class="flex-1 overflow-hidden relative w-full">
            <!-- Modal: Add Student -->
            <div id="add-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
                <div class="bg-white rounded-lg p-6 w-full max-w-sm">
                    <h3 class="text-lg font-bold mb-4">Add Student</h3>
                    <input type="text" id="modal-roll" class="w-full border rounded p-2 mb-2" placeholder="Roll No">
                    <input type="text" id="modal-name" class="w-full border rounded p-2 mb-4" placeholder="Name">
                    <div class="flex gap-2">
                        <button onclick="window.toggleAddModal()" class="flex-1 border py-2 rounded">Cancel</button>
                        <button onclick="window.saveStudentFromModal()" class="flex-1 bg-blue-600 text-white py-2 rounded">Add</button>
                    </div>
                </div>
            </div>

            <!-- VIEW: Daily -->
            <section id="view-daily" class="h-full flex flex-col">
                <div class="bg-white p-3 shadow-sm border-b z-20 space-y-3">
                    <div class="flex justify-between items-center">
                        <input type="date" id="attendance-date" class="border rounded p-2 text-sm" onchange="window.handleDateChange()">
                        <button onclick="window.saveCurrentDay()" id="btn-save-cloud" class="bg-green-600 text-white px-4 py-2 rounded text-sm shadow">Save to Cloud</button>
                    </div>
                    <div class="flex gap-2 items-center">
                        <input type="text" id="student-search" onkeyup="window.loadDailyAttendance()" placeholder="Search..." class="w-full border rounded-full px-4 py-1.5 text-sm">
                        <span id="student-count-display" class="text-xs bg-gray-200 px-2 py-1 rounded font-bold">0 Students</span>
                    </div>
                    <div class="flex flex-wrap gap-2" id="subject-toggles"></div>
                </div>
                <div class="bg-white flex-1 overflow-y-auto table-container relative">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-50 sticky top-0 z-10"><tr class="text-xs text-gray-500"><th class="p-3 border-b">Roll</th><th class="p-3 border-b">Name</th><th class="p-3 border-b text-center">Action</th><th class="p-3 border-b">Attendance</th></tr></thead>
                        <tbody id="daily-list" class="text-sm divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </section>

            <!-- VIEW: Report -->
            <section id="view-report" class="h-full flex flex-col hidden">
                <div class="bg-white p-3 shadow-sm border-b space-y-3">
                    <div class="flex justify-between items-center gap-2 flex-wrap">
                        <input type="month" id="report-month" class="border rounded p-2 text-sm" onchange="window.generateReport()">
                        <div class="flex gap-2">
                             <input type="file" id="restore-csv" class="hidden" onchange="window.restoreAttendanceCSV(this)">
                             <button onclick="document.getElementById('restore-csv').click()" class="bg-yellow-600 text-white px-2 py-1 rounded text-xs">Restore</button>
                             <button onclick="window.backupAttendanceCSV()" class="bg-green-600 text-white px-2 py-1 rounded text-xs">Backup</button>
                             <button onclick="window.exportTableToCSV('report-table')" class="bg-blue-600 text-white px-2 py-1 rounded text-xs">Export</button>
                        </div>
                    </div>
                    <div id="report-summary" class="text-xs text-blue-800 bg-blue-50 p-2 rounded">Select month.</div>
                </div>
                <div class="bg-white flex-1 overflow-auto table-container">
                    <table class="w-full text-left border-collapse text-xs sm:text-sm" id="report-table">
                        <thead class="bg-gray-50 sticky top-0 z-10"><tr id="report-header-row" class="shadow-sm"></tr></thead>
                        <tbody id="report-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </section>

            <!-- VIEW: Students -->
            <section id="view-students" class="h-full flex flex-col hidden">
                <div class="flex-1 overflow-y-auto p-4">
                    <div class="bg-white p-4 rounded shadow border max-w-lg mx-auto">
                        <div class="flex justify-between mb-4">
                            <h2 class="font-bold">Class List</h2>
                            <input type="file" id="csvInput" class="hidden" onchange="window.processCSV(this)">
                            <button onclick="document.getElementById('csvInput').click()" class="bg-green-600 text-white px-3 py-1 rounded text-xs">Import CSV</button>
                        </div>
                        <div class="max-h-[60vh] overflow-y-auto border rounded">
                            <table class="w-full text-left text-sm"><thead class="bg-gray-100 sticky top-0"><tr><th class="p-2">Roll</th><th class="p-2">Name</th><th class="p-2 text-right">Action</th></tr></thead><tbody id="student-list-manage"></tbody></table>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Edit Teacher Modal -->
    <div id="admin-edit-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold mb-4">Edit Teacher</h3>
            <div class="space-y-4">
                <div><label class="block text-xs font-bold uppercase">Name</label><input type="text" id="edit-t-name" class="w-full border rounded p-2 text-sm"></div>
                <div><label class="block text-xs font-bold uppercase">Email</label><input type="text" id="edit-t-email" class="w-full border rounded p-2 text-sm"></div>
                <div><label class="block text-xs font-bold uppercase">Password</label><input type="text" id="edit-t-pass" class="w-full border rounded p-2 text-sm" placeholder="Reset Password"></div>
                <div class="flex gap-2">
                    <button onclick="window.safeClassList('admin-edit-modal', 'add', 'hidden')" class="flex-1 border py-2 rounded">Cancel</button>
                    <button onclick="window.adminSaveTeacherEdit()" class="flex-1 bg-blue-600 text-white py-2 rounded">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. LOGIC MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, signOut, onAuthStateChanged, setPersistence, inMemoryPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDrkpeF8kEXw8E6oE7LwgqnfthUFjqNBOQ",
            authDomain: "forteatt-361bc.firebaseapp.com",
            projectId: "forteatt-361bc",
            storageBucket: "forteatt-361bc.firebasestorage.app",
            messagingSenderId: "216222461040",
            appId: "1:216222461040:web:3c4905210b76cb32ed58b5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'forteatt-361bc';

        // State
        let students = [], attendanceData = {}, activeSubjects = {}, dailyUnsub = null;
        let schoolData = { classes: [], teachers: [], subjects: ["MATH", "COMP", "URDU", "ISL", "QURAN", "PHY", "ENG"], class_subjects: {}, admin: { email: 'admin@forte.com', password: 'admin' } };
        let allSubjects = []; // Dynamically loaded
        let liveDashboardUnsubs = []; // Store unsubs for dashboard

        // --- DEFINITIONS FIRST ---

        async function updateConfig() {
            if(!auth.currentUser) return alert("You are not logged in.");
            try {
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'config', 'school_data');
                await setDoc(ref, window.schoolData);
            } catch (error) {
                console.error("Save failed:", error);
                alert("Cloud Save Failed: " + error.message);
            }
        }

        window.loadSchoolConfig = function() {
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'school_data'), (snap) => {
                if(snap.exists()) {
                    const data = snap.data();
                    window.schoolData = {
                        classes: data.classes || [],
                        teachers: data.teachers || [],
                        subjects: data.subjects || ["MATH", "COMP", "URDU", "ISL", "QURAN", "PHY", "ENG"],
                        class_subjects: data.class_subjects || {},
                        admin: data.admin || { email: 'admin@forte.com', password: 'admin' }
                    };
                } else {
                    const init = { 
                        classes: [], teachers: [], 
                        subjects: ["MATH", "COMP", "URDU", "ISL", "QURAN", "PHY", "ENG"], 
                        class_subjects: {},
                        admin: { email: 'admin@forte.com', password: 'admin' } 
                    };
                    setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'school_data'), init);
                    window.schoolData = init;
                }
                
                // Set global subjects
                allSubjects = window.schoolData.subjects;
                allSubjects.forEach(s => { if(activeSubjects[s] === undefined) activeSubjects[s] = true; });

                window.dataLoaded = true;
                if(!document.getElementById('view-admin').classList.contains('hidden')) {
                    window.renderAdminPanel();
                    window.initAdminLiveDashboard(); 
                }
            });
        };
        
        window.getCurrentSubjects = () => {
             // Logic: Global + Specific
             const globals = window.schoolData.subjects || [];
             const specific = (window.currentClassId && window.schoolData.class_subjects && window.schoolData.class_subjects[window.currentClassId]) || [];
             // Unique Union
             return Array.from(new Set([...globals, ...specific]));
        };

        // --- NEW LOGIN HANDLER ---
        window.handleLogin = async (type) => {
            const email = document.getElementById(`login-${type}-email`).value.trim();
            const pass = document.getElementById(`login-${type}-pass`).value.trim();
            
            if(!email || !pass) return alert("Please fill all fields");
            
            const btn = document.getElementById(`btn-login-${type}`);
            const originalText = btn.innerText;
            btn.innerText = "Verifying...";
            btn.disabled = true;

            try {
                // 1. Authenticate with Firebase
                await signInWithEmailAndPassword(auth, email, pass);
                
                // 2. Determine Role & Route
                if (type === 'admin') {
                    // Admin logic
                    localStorage.setItem('fcs_role', 'admin');
                    window.checkSession();
                } else {
                    // Teacher logic: Must match an entry in School Data
                    const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'school_data'));
                    if (snap.exists()) {
                        const data = snap.data();
                        const teachers = data.teachers || [];
                        const teacher = teachers.find(t => t.email.toLowerCase() === email.toLowerCase());
                        
                        if (teacher) {
                            // Populate Class Select
                            const select = document.getElementById('login-class-select');
                            select.innerHTML = '';
                            if(teacher.assignedClasses && teacher.assignedClasses.length > 0) {
                                teacher.assignedClasses.forEach(c => select.innerHTML += `<option value="${c}">${c}</option>`);
                                document.getElementById('class-select-area').classList.remove('hidden');
                                window.tempTeacherName = teacher.name;
                            } else {
                                alert("Login successful, but no classes assigned. Contact Admin.");
                            }
                        } else {
                            alert("This email is not in the Teacher List. Contact Admin.");
                            await signOut(auth);
                        }
                    } else {
                        alert("System Error: Could not load school data.");
                    }
                }
            } catch (error) {
                console.error(error);
                let msg = "Login Failed: " + error.message;
                if(error.code === 'auth/invalid-credential') msg = "Incorrect Email or Password";
                alert(msg);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };

        // --- ADMIN: ADD TEACHER WITH FIREBASE AUTH ---
        window.adminAddTeacher = async () => {
            const name = document.getElementById('new-teacher-name').value.trim();
            const email = document.getElementById('new-teacher-email').value.trim();
            const pass = document.getElementById('new-teacher-pass').value.trim();
            const cls = document.getElementById('new-teacher-class').value;

            if(!name || !email || !pass) return alert("Fill all fields");

            const btn = document.querySelector('button[onclick="window.adminAddTeacher()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
            btn.disabled = true;

            // 1. Create Auth User (Using Secondary App Trick)
            try {
                const tempApp = initializeApp(firebaseConfig, "Secondary");
                const tempAuth = getAuth(tempApp);
                
                await createUserWithEmailAndPassword(tempAuth, email, pass);
                await signOut(tempAuth); // Sign out immediately
                
            } catch(e) {
                alert("Error creating login: " + e.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }

            // 2. Save to Firestore
            const assigned = cls ? [cls] : [];
            window.schoolData.teachers.push({name, email, password: pass, assignedClasses: assigned}); // Password stored just for ref
            await updateConfig();
            
            document.getElementById('new-teacher-name').value = '';
            document.getElementById('new-teacher-email').value = '';
            document.getElementById('new-teacher-pass').value = '';
            
            btn.innerHTML = originalText;
            btn.disabled = false;
            window.renderAdminPanel();
            alert("Teacher Created Successfully!");
        };

        // --- ADMIN SUBJECT MANAGEMENT (RESTORED) ---
        window.adminAddGlobalSubject = async () => {
            const name = document.getElementById('new-subject-name').value.toUpperCase().trim();
            if(!name) return;
            if(!window.schoolData.subjects) window.schoolData.subjects = [];
            if(window.schoolData.subjects.includes(name)) return alert("Already exists in Global");
            window.schoolData.subjects.push(name);
            await updateConfig();
            document.getElementById('new-subject-name').value = '';
            window.renderAdminPanel();
        };

        window.adminDeleteGlobalSubject = async (idx) => {
            if(confirm("Delete Global Subject?")) {
                window.schoolData.subjects.splice(idx, 1);
                await updateConfig();
                window.renderAdminPanel();
            }
        };

        window.promptAddSpecific = async (cls) => {
             const name = prompt(`Add subject for ${cls}:`);
             if(name) {
                 const upper = name.toUpperCase().trim();
                 if(!window.schoolData.class_subjects) window.schoolData.class_subjects = {};
                 if(!window.schoolData.class_subjects[cls]) window.schoolData.class_subjects[cls] = [];
                 
                 if(!window.schoolData.class_subjects[cls].includes(upper)) {
                     window.schoolData.class_subjects[cls].push(upper);
                     await updateConfig();
                     window.renderAdminPanel();
                 }
             }
        };
        
        window.adminDeleteSpecificSubject = async (cls, idx) => {
             if(confirm(`Remove subject from ${cls}?`)) {
                 if(window.schoolData.class_subjects && window.schoolData.class_subjects[cls]) {
                     window.schoolData.class_subjects[cls].splice(idx, 1);
                     await updateConfig();
                     window.renderAdminPanel();
                 }
             }
        };

        window.adminEditClass = async (idx) => {
            const old = window.schoolData.classes[idx];
            const name = prompt("New Name:", old);
            if(name && name!==old) {
                const upperName = name.trim().toUpperCase();
                if(window.schoolData.classes.includes(upperName)) { alert("Name taken."); return; }
                window.schoolData.classes[idx] = upperName;
                await updateConfig();
                window.renderAdminPanel();
            }
        };

        window.adminDeleteClass = async (idx) => {
            if(confirm("Delete Class?")) {
                window.schoolData.classes.splice(idx,1);
                await updateConfig();
                window.renderAdminPanel();
            }
        };
        
        window.adminEditTeacher = (idx) => {
            window.editingTeacherIdx = idx;
            document.getElementById('edit-t-name').value = window.schoolData.teachers[idx].name;
            document.getElementById('edit-t-email').value = window.schoolData.teachers[idx].email;
            document.getElementById('edit-t-pass').value = window.schoolData.teachers[idx].password;
            window.safeClassList('admin-edit-modal', 'remove', 'hidden');
        };

        window.adminSaveTeacherEdit = async () => {
             const t = window.schoolData.teachers[window.editingTeacherIdx];
             t.name = document.getElementById('edit-t-name').value.trim();
             t.email = document.getElementById('edit-t-email').value.trim();
             t.password = document.getElementById('edit-t-pass').value.trim();
             await updateConfig();
             window.safeClassList('admin-edit-modal', 'add', 'hidden');
             window.editingTeacherIdx = null;
        };

        window.adminDeleteTeacher = async (idx) => {
             if(confirm("Delete Teacher?")) {
                 window.schoolData.teachers.splice(idx,1);
                 await updateConfig();
                 window.renderAdminPanel();
             }
        };

        window.adminToggleClassAssignment = async (idx, cls, checked) => {
            let t = window.schoolData.teachers[idx];
            if(!t.assignedClasses) t.assignedClasses = [];
            if(checked) t.assignedClasses.push(cls);
            else t.assignedClasses = t.assignedClasses.filter(c=>c!==cls);
            window.schoolData.teachers[idx].assignedClasses = t.assignedClasses;
            await updateConfig();
        };

        window.adminViewClass = (cls) => {
            window.currentClassId = cls;
            window.teacherName = "Admin View";
            localStorage.setItem('fcs_admin_view_class', cls);
            document.getElementById('view-admin').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('btn-back-dashboard').classList.remove('hidden');
            document.getElementById('header-class-name').innerText = cls;
            window.initClassData(cls);
        };

        window.backToDashboard = () => {
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('view-admin').classList.remove('hidden');
            localStorage.removeItem('fcs_admin_view_class');
            if(dailyUnsub) dailyUnsub();
            window.currentClassId = "";
        };

        window.renderStudentManager = function() {
            const list = document.getElementById('student-list-manage');
            if(!list) return;
            list.innerHTML = '';
            const sorted = [...students].sort((a,b) => a.rollNo.localeCompare(b.rollNo, undefined, {numeric:true}));
            sorted.forEach((s, idx) => {
                list.innerHTML += `<tr>
                    <td class="p-3"><input type="text" value="${s.rollNo}" onchange="window.updateStudent(${idx},'rollNo',this.value)" class="border-b w-12 text-center"></td>
                    <td class="p-3"><input type="text" value="${s.name}" onchange="window.updateStudent(${idx},'name',this.value)" class="border-b w-full"></td>
                    <td class="p-3 text-right"><button onclick="window.deleteStudent(${idx})" class="text-red-500"><i class="fas fa-trash"></i></button></td>
                </tr>`;
            });
        };
        
        window.updateStudent = async (idx, field, val) => {
            students[idx][field] = val;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'classes', window.currentClassId), {students}, {merge:true});
        };
        
        window.deleteStudent = async (idx) => {
            if(confirm("Delete?")) {
                students.splice(idx, 1);
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'classes', window.currentClassId), {students}, {merge:true});
                window.renderStudentManager();
            }
        };

        window.saveStudentFromModal = async () => {
             const r = document.getElementById('modal-roll').value;
             const n = document.getElementById('modal-name').value;
             if(r && n) {
                 students.push({id: Date.now(), rollNo: r, name: n});
                 await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'classes', window.currentClassId), {students}, {merge:true});
                 window.toggleAddModal();
             }
        };

        window.processCSV = (input) => { 
             const f=input.files[0]; if(!f)return;
             const r=new FileReader();
             r.onload=async(e)=>{
                 const lines=e.target.result.split('\n');
                 const newSt=[];
                 lines.forEach(l=>{
                     const [roll, name]=l.split(',');
                     if(roll && name) newSt.push({id:Date.now()+Math.random(), rollNo:roll.trim(), name:name.trim()});
                 });
                 if(newSt.length){
                     students=newSt;
                     await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'classes', window.currentClassId), {students}, {merge:true});
                     window.showToast("Imported");
                 }
             };
             r.readAsText(f);
        };

        window.generateReport = async () => {
             const monthInput = document.getElementById('report-month').value;
             const tbody = document.getElementById('report-body');
             if(tbody) tbody.innerHTML = '<tr><td colspan="100%" class="text-center p-4">Loading...</td></tr>';
             const [y, m] = monthInput.split('-').map(Number);
             const days = new Date(y, m, 0).getDate();
             let promises = [];
             let fetchedDays = [];
             
             for(let d=1; d<=days; d++) {
                 const dateStr = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                 promises.push(getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', `${window.currentClassId}_${dateStr}`)).then(s=>({date:dateStr, snap:s})));
             }
             const results = await Promise.all(promises);
             const reportData = {};
             const subList = window.getCurrentSubjects();
             let lectures = {}; subList.forEach(s=>lectures[s]=0);
             
             results.forEach(r => {
                 if(r.snap.exists()) {
                     reportData[r.date] = r.snap.data().records;
                     fetchedDays.push(r.date);
                     if(students.length>0) {
                         const rec = reportData[r.date][students[0].id];
                         if(rec) subList.forEach(s=>{ if(rec[s] !== '-') lectures[s]++; });
                     }
                 }
             });
             
             const totalLec = Object.values(lectures).reduce((a,b)=>a+b,0);
             const thead = document.getElementById('report-header-row');
             if(thead) {
                 let h = '<th>Roll</th><th>Name</th><th>% Lec</th><th>% Day</th><th>A</th><th>L</th><th>SL</th>';
                 thead.innerHTML = h;
             }
             
             if(tbody) {
                 tbody.innerHTML = '';
                 students.forEach(stu => {
                     let attLec=0, absent=0, leave=0, short=0, presentDay=0;
                     fetchedDays.forEach(d => {
                         const rec = reportData[d]?.[stu.id];
                         if(rec) {
                             let hasP=false, hasA=false, hasL=false, hasData=false;
                             subList.forEach(s => {
                                 const st = rec[s];
                                 if(st && st !== '-') {
                                     hasData=true;
                                     if(st==='P') { attLec++; hasP=true; }
                                     if(st==='A') hasA=true;
                                     if(st==='L') hasL=true;
                                 }
                             });
                             if(hasData) {
                                 if(hasP) { presentDay++; if(hasA||hasL) short++; }
                                 else { if(hasL) leave++; else if(hasA) absent++; }
                             }
                         }
                     });
                     
                     let pctLec = totalLec>0 ? Math.round((attLec/totalLec)*100) : 0;
                     let totalDays = fetchedDays.length;
                     let pctDay = totalDays>0 ? Math.round((presentDay/totalDays)*100) : 0;
                     
                     tbody.innerHTML += `<tr>
                         <td class="text-center font-bold p-2">${stu.rollNo}</td>
                         <td class="p-2">${stu.name}</td>
                         <td class="text-center font-bold text-blue-600">${pctLec}%</td>
                         <td class="text-center font-bold text-green-600">${pctDay}%</td>
                         <td class="text-center font-bold text-red-600">${absent}</td>
                         <td class="text-center font-bold text-yellow-600">${leave}</td>
                         <td class="text-center font-bold text-orange-600">${short}</td>
                     </tr>`;
                 });
             }
        };
        
        // --- NEW ADMIN REPORT DOWNLOADS ---
        window.adminDownloadMonthlyReport = async () => {
            const cls = document.getElementById('admin-rep-class').value;
            const month = document.getElementById('admin-rep-month').value;
            if(!cls || !month) return alert("Select Class and Month");
            
            window.showToast("Fetching data...");
            
            // 1. Get Students
            const classSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'classes', cls));
            const studList = classSnap.exists() ? (classSnap.data().students || []) : [];
            
            if(studList.length === 0) return alert("No students in this class");

            // 2. Get Days
            const [y, m] = month.split('-').map(Number);
            const days = new Date(y, m, 0).getDate();
            let promises = [];
            
            for(let d=1; d<=days; d++) {
                const dateStr = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                promises.push(getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', `${cls}_${dateStr}`)).then(s=>({date:dateStr, snap:s})));
            }
            
            const results = await Promise.all(promises);
            
            // 3. Build CSV
            const clsSubjects = window.schoolData.class_subjects?.[cls] || window.schoolData.subjects;
            let csv = ["Date,Roll No,Name," + clsSubjects.join(",")];
            
            results.forEach(r => {
                if(r.snap.exists()) {
                     const records = r.snap.data().records;
                     studList.forEach(s => {
                         const rec = records[s.id];
                         if(rec) {
                             let row = [r.date, s.rollNo, s.name];
                             clsSubjects.forEach(sub => row.push(rec[sub]||'-'));
                             csv.push(row.join(","));
                         }
                     });
                }
            });
            
            const blob = new Blob([csv.join("\n")], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `${cls}_${month}_Report.csv`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        };

        window.adminDownloadDailySummary = async () => {
            const date = document.getElementById('admin-rep-date').value;
            if(!date) return alert("Select Date");
            
            window.showToast("Compiling Summary...");
            
            let csv = ["Class Name,Total Students,Present (Full),Short Leave,Absent,Leave"];
            const classes = window.schoolData.classes;
            
            for(const cls of classes) {
                const attSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', `${cls}_${date}`));
                let p=0, sl=0, a=0, l=0;
                let total = 0; 
                
                if(attSnap.exists()) {
                    const records = attSnap.data().records;
                    const studentIds = Object.keys(records);
                    total = studentIds.length;
                    
                    const clsSubjects = window.schoolData.class_subjects?.[cls] || window.schoolData.subjects;

                    studentIds.forEach(id => {
                        const rec = records[id];
                        let hasP=false, hasA=false, hasL=false, hasData=false;
                        clsSubjects.forEach(sub => {
                            const st = rec[sub];
                            if(st && st !== '-') {
                                hasData=true;
                                if(st==='P') hasP=true;
                                if(st==='A') hasA=true;
                                if(st==='L') hasL=true;
                            }
                        });
                        
                        if(hasData) {
                            if(hasP) {
                                if(hasA || hasL) sl++;
                                else p++;
                            } else {
                                if(hasL) l++;
                                else if(hasA) a++;
                            }
                        }
                    });
                    csv.push(`${cls},${total},${p},${sl},${a},${l}`);
                } else {
                     csv.push(`${cls},-,Not Marked,-,-,-`);
                }
            }
            
            const blob = new Blob([csv.join("\n")], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `Summary_${date}.csv`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        };

        // --- BACKUP & RESTORE CSV ---
        window.backupAttendanceCSV = async function() {
            const monthInput = document.getElementById('report-month').value;
            if(!monthInput) { alert("Please select a month."); return; }
            const [y, m] = monthInput.split('-').map(Number);
            const days = new Date(y, m, 0).getDate();
            window.showToast("Generating Backup...");
            let promises = [];
            for(let d=1; d<=days; d++) {
                const dateStr = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                promises.push(getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', `${window.currentClassId}_${dateStr}`)).then(snap => ({date: dateStr, snap})));
            }
            const results = await Promise.all(promises);
            const subList = window.getCurrentSubjects();
            let csvRows = ["Date,Roll No,Student Name," + subList.join(",")];
            results.forEach(r => {
                if(r.snap.exists()) {
                    const records = r.snap.data().records;
                    students.forEach(stu => {
                        const rec = records[stu.id];
                        if (rec) {
                            let row = [r.date, `"${stu.rollNo}"`, `"${stu.name}"`];
                            subList.forEach(sub => row.push(rec[sub] || "-"));
                            csvRows.push(row.join(","));
                        }
                    });
                }
            });
            if (csvRows.length <= 1) { alert("No data found."); return; }
            const blob = new Blob([csvRows.join("\n")], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `backup_${window.currentClassId}_${monthInput}.csv`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        };

        window.restoreAttendanceCSV = function(input) {
            const file = input.files[0];
            if(!file) return;
            if(!confirm("Restore will overwrite data. Continue?")) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const lines = e.target.result.split('\n');
                const header = lines[0].split(',').map(h => h.trim());
                const idxDate = header.indexOf("Date");
                const idxRoll = header.indexOf("Roll No");
                const subjIndices = {};
                const subList = window.getCurrentSubjects();
                
                subList.forEach(sub => {
                    const idx = header.indexOf(sub);
                    if(idx !== -1) subjIndices[sub] = idx;
                });

                if(idxDate === -1 || idxRoll === -1) {
                    alert("Invalid CSV format. Header must contain 'Date' and 'Roll No'.");
                    return;
                }

                const batchData = {}; 

                for(let i=1; i<lines.length; i++) {
                    const line = lines[i].trim();
                    if(!line) continue;
                    const parts = line.split(','); 
                    const rollNo = parts[idxRoll].replace(/"/g, "").trim();
                    const dateStr = parts[idxDate];
                    const student = students.find(s => s.rollNo === rollNo);
                    if(student) {
                        if(!batchData[dateStr]) batchData[dateStr] = {};
                        if(!batchData[dateStr][student.id]) batchData[dateStr][student.id] = {};
                        subList.forEach(sub => {
                            const idx = subjIndices[sub];
                            if(idx !== undefined && parts[idx]) batchData[dateStr][student.id][sub] = parts[idx].trim();
                        });
                    }
                }
                const dates = Object.keys(batchData);
                for(const date of dates) {
                    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'attendance', `${window.currentClassId}_${date}`);
                    try {
                        const snap = await getDoc(ref);
                        let existingRecords = snap.exists() ? snap.data().records : {};
                        const newRecords = batchData[date];
                        Object.keys(newRecords).forEach(sid => existingRecords[sid] = newRecords[sid]);
                        await setDoc(ref, { date: date, classId: window.currentClassId, records: existingRecords });
                    } catch(err) { console.error(err); }
                }
                window.showToast("Restored!");
                window.loadDailyAttendance(); 
                input.value = '';
            };
            reader.readAsText(file);
        };
        
        // --- ADD MISSING LOGOUT / ENTER CLASS ---
        window.logout = async () => {
            if(confirm("Log out?")) {
                localStorage.clear();
                await signOut(auth);
                location.reload();
            }
        };

        window.enterClass = () => {
            const cls = document.getElementById('login-class-select').value;
            localStorage.setItem('fcs_role', 'teacher');
            localStorage.setItem('fcs_class', cls);
            localStorage.setItem('fcs_teacher', window.tempTeacherName);
            window.checkSession();
        };

        window.verifyTeacher = () => window.handleLogin('teacher');
        window.adminLogin = () => window.handleLogin('admin');

        // --- INIT ---
        const d = new Date().toISOString().split('T')[0];
        const di = document.getElementById('attendance-date');
        if(di) di.value = d;
        const now = new Date();
        const monthStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        document.getElementById('report-month').value = monthStr;
        
        const adminRepMonth = document.getElementById('admin-rep-month');
        if(adminRepMonth) adminRepMonth.value = monthStr;
        
        const adminRepDate = document.getElementById('admin-rep-date');
        if(adminRepDate) adminRepDate.value = d;
        
        // Restore Logo
        const l = localStorage.getItem('att_logo_img');
        if(l) { 
            const img = document.getElementById('app-logo');
            if(img) {
                img.src = l; 
                img.classList.remove('hidden'); 
                document.getElementById('default-logo-icon').classList.add('hidden'); 
            }
        }

        // Exec
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Logged In");
                document.getElementById('sys-status').innerText = "Connected";
                document.getElementById('sys-status').classList.replace('text-orange-500','text-green-500');
                window.loadSchoolConfig();
                window.checkSession();
            } else {
                // If not logged in, we don't do anything special here as per request
            }
        });
    </script>
</body>
</html>
