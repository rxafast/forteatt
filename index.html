<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Forte Admin | Modern</title>
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: '#4f46e5', // Indigo 600
                        secondary: '#64748b', // Slate 500
                        background: '#f8fafc', // Slate 50
                    }
                }
            }
        }
    </script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .status-btn { transition: all 0.1s ease; }
        .status-btn:active { transform: scale(0.95); }

        /* Sticky Columns */
        .sticky-col-1 { position: sticky; left: 0; z-index: 10; }
        .sticky-col-2 { position: sticky; left: 60px; z-index: 10; }
    </style>
</head>
<body class="bg-background text-slate-800 h-screen flex flex-col overflow-hidden font-sans">

    <div id="toast-container" class="fixed top-4 left-1/2 -translate-x-1/2 z-[60] flex flex-col gap-2 pointer-events-none"></div>

    <!-- LOGIN SCREEN -->
    <div id="view-login" class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-indigo-900 to-slate-900 p-4 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all duration-300 scale-100">
            <div class="bg-primary p-8 text-center relative overflow-hidden">
                <div class="absolute inset-0 bg-black/10"></div>
                <div class="relative z-10">
                    <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-3 backdrop-blur-sm">
                        <i class="fas fa-graduation-cap text-3xl text-white"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-white tracking-tight">Forte College</h1>
                    <p id="conn-status" class="text-indigo-200 text-xs font-medium mt-1 uppercase tracking-wider">System Ready</p>
                </div>
            </div>

            <div class="flex border-b border-slate-100">
                <button onclick="ui.setLoginTab('teacher')" id="tab-login-teacher" class="flex-1 py-4 text-sm font-semibold text-primary border-b-2 border-primary bg-indigo-50/50 transition-colors">Teacher</button>
                <button onclick="ui.setLoginTab('admin')" id="tab-login-admin" class="flex-1 py-4 text-sm font-medium text-slate-400 hover:text-slate-600 transition-colors">Administrator</button>
            </div>

            <div class="p-8">
                <!-- Teacher Form -->
                <div id="form-teacher" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Email</label>
                        <input type="email" id="inp-teacher-email" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm" placeholder="teacher@forte.com">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password</label>
                        <input type="password" id="inp-teacher-pass" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm" placeholder="••••••••">
                    </div>
                    <div id="teacher-class-select-wrapper" class="hidden">
                         <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Select Class</label>
                         <select id="inp-teacher-class" class="w-full p-2.5 bg-white border border-slate-200 rounded-lg text-sm mb-2"></select>
                         <button onclick="auth.enterClass()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-lg">Enter Class</button>
                    </div>
                    <button id="btn-teacher-login" onclick="auth.login('teacher')" class="w-full bg-primary hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-lg">Login</button>
                </div>

                <!-- Admin Form -->
                <div id="form-admin" class="space-y-4 hidden">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Admin Email</label>
                        <input type="email" id="inp-admin-email" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm" placeholder="admin@forte.com">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password</label>
                        <input type="password" id="inp-admin-pass" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm" placeholder="••••••••">
                    </div>
                    <button id="btn-admin-login" onclick="auth.login('admin')" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-lg shadow-lg">Access Dashboard</button>
                    <div class="text-center mt-4">
                        <button onclick="auth.resetPass()" class="text-xs text-primary hover:underline">Forgot Password?</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="view-app" class="flex-1 flex flex-col h-full hidden">
        <header class="bg-white border-b border-slate-200 px-4 py-3 flex justify-between items-center shadow-sm z-30 shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-primary text-white flex items-center justify-center font-bold text-lg">F</div>
                <div>
                    <h1 class="font-bold text-slate-800 text-sm leading-tight" id="header-title">Dashboard</h1>
                    <p class="text-[10px] text-slate-500 font-medium" id="header-subtitle">Welcome</p>
                </div>
            </div>
            <button onclick="auth.logout()" class="text-slate-400 hover:text-red-500 p-2 rounded-full hover:bg-red-50 transition-colors" title="Logout"><i class="fas fa-power-off"></i></button>
        </header>

        <div class="flex-1 overflow-hidden relative flex">
            <!-- Sidebar -->
            <aside id="admin-sidebar" class="hidden w-64 bg-slate-900 text-slate-300 flex-col border-r border-slate-800 h-full">
                <div class="p-4 space-y-1">
                    <button onclick="ui.switchAdminTab('dashboard')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 transition flex items-center gap-3" id="nav-dashboard"><i class="fas fa-home w-5"></i> Dashboard</button>
                    <button onclick="ui.switchAdminTab('teachers')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 transition flex items-center gap-3" id="nav-teachers"><i class="fas fa-chalkboard-teacher w-5"></i> Teachers</button>
                    <button onclick="ui.switchAdminTab('classes')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 transition flex items-center gap-3" id="nav-classes"><i class="fas fa-layer-group w-5"></i> Classes</button>
                    <button onclick="ui.switchAdminTab('subjects')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 transition flex items-center gap-3" id="nav-subjects"><i class="fas fa-book w-5"></i> Subjects</button>
                    <button onclick="ui.switchAdminTab('reports')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 transition flex items-center gap-3" id="nav-reports"><i class="fas fa-file-csv w-5"></i> Reports</button>
                </div>
            </aside>

            <main class="flex-1 overflow-y-auto bg-slate-50 p-4 md:p-6 w-full relative">
                
                <!-- TEACHER ATTENDANCE -->
                <div id="view-teacher-attendance" class="hidden max-w-6xl mx-auto">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-4 sticky top-0 z-20 space-y-3">
                        <div class="flex flex-col md:flex-row justify-between gap-3">
                            <div class="flex gap-2 items-center flex-wrap">
                                <input type="date" id="att-date" class="border border-slate-300 rounded-lg px-3 py-2 text-sm font-medium text-slate-700 outline-none" onchange="teacher.loadData()">
                                <span id="student-count" class="text-xs font-bold bg-slate-100 px-2 py-1 rounded text-slate-600">0 Students</span>
                            </div>
                            <div class="flex gap-2 w-full md:w-auto">
                                <button onclick="teacher.openAddStudentModal()" class="bg-blue-50 text-blue-600 border border-blue-200 hover:bg-blue-100 px-3 py-2 rounded-lg text-sm font-bold flex items-center gap-2"><i class="fas fa-user-plus"></i> Add</button>
                                <label class="bg-blue-50 text-blue-600 border border-blue-200 hover:bg-blue-100 px-3 py-2 rounded-lg text-sm font-bold flex items-center gap-2 cursor-pointer">
                                    <i class="fas fa-file-upload"></i> Import CSV <input type="file" class="hidden" accept=".csv" onchange="teacher.importFile(this)">
                                </label>
                                <button onclick="teacher.save()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm flex items-center gap-2 ml-auto"><i class="fas fa-save"></i> Save Attendance</button>
                            </div>
                        </div>
                        <div class="space-y-2">
                             <div class="flex gap-2"><input type="text" id="att-search" placeholder="Search student..." class="flex-1 border border-slate-300 rounded-lg px-3 py-2 text-sm outline-none" onkeyup="teacher.filter()"></div>
                             <div class="bg-indigo-50 border border-indigo-100 p-2 rounded-lg">
                                 <div class="text-[10px] uppercase font-bold text-indigo-400 mb-1">Select Subjects Taught Today:</div>
                                 <div id="att-subjects-filter" class="flex flex-wrap gap-2 items-center"></div>
                             </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-x-auto">
                        <table class="w-full text-left text-sm whitespace-nowrap">
                            <thead id="att-thead" class="bg-slate-100 text-slate-600 uppercase text-xs font-bold border-b border-slate-200"></thead>
                            <tbody id="att-list" class="divide-y divide-slate-100 text-slate-700"></tbody>
                        </table>
                    </div>
                </div>

                <!-- ADMIN DASHBOARD -->
                <div id="view-admin-dashboard" class="hidden space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><div class="text-slate-500 text-xs font-bold uppercase mb-1">Total Teachers</div><div class="text-3xl font-bold text-slate-800" id="stat-t">0</div></div>
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><div class="text-slate-500 text-xs font-bold uppercase mb-1">Total Classes</div><div class="text-3xl font-bold text-slate-800" id="stat-c">0</div></div>
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><div class="text-slate-500 text-xs font-bold uppercase mb-1">Subjects</div><div class="text-3xl font-bold text-slate-800" id="stat-s">0</div></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                            <h3 class="font-bold text-slate-700">Live Attendance Feed</h3>
                            <div class="flex items-center gap-2">
                                <input type="date" id="live-date" class="border rounded px-2 py-1 text-xs" onchange="admin.initLive()">
                                <button onclick="admin.initLive()" class="text-primary hover:bg-indigo-50 p-1.5 rounded"><i class="fas fa-sync-alt"></i></button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50 text-xs text-slate-500 uppercase">
                                    <tr><th class="px-6 py-3">Class</th><th class="px-6 py-3 text-center text-green-600">Present</th><th class="px-6 py-3 text-center text-red-600">Absent</th><th class="px-6 py-3 text-center text-yellow-600">Leave</th><th class="px-6 py-3 text-center text-orange-500">S-Leave</th></tr>
                                </thead>
                                <tbody id="live-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ADMIN: TEACHERS -->
                <div id="view-admin-teachers" class="hidden space-y-4">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-lg mb-4">Register New Teacher</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <input type="text" id="new-t-name" placeholder="Full Name" class="border rounded-lg p-2.5 text-sm">
                            <input type="email" id="new-t-email" placeholder="Email Address" class="border rounded-lg p-2.5 text-sm">
                            <input type="password" id="new-t-pass" placeholder="Password (Min 6)" class="border rounded-lg p-2.5 text-sm">
                            <select id="new-t-class" class="border rounded-lg p-2.5 text-sm bg-white"></select>
                        </div>
                        <button onclick="admin.addTeacher()" class="bg-primary text-white px-6 py-2.5 rounded-lg text-sm font-bold hover:bg-indigo-700 transition">Create Teacher</button>
                    </div>
                    <div id="list-teachers" class="space-y-3"></div>
                </div>

                <!-- ADMIN: CLASSES -->
                <div id="view-admin-classes" class="hidden space-y-4">
                    <div class="flex gap-3 mb-4">
                        <input type="text" id="new-c-name" placeholder="e.g. ICS-A" class="border rounded-lg p-2.5 text-sm uppercase w-full md:w-64">
                        <button onclick="admin.addClass()" class="bg-green-600 text-white px-6 py-2.5 rounded-lg text-sm font-bold hover:bg-green-700">Add Class</button>
                    </div>
                    <div id="list-classes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>

                <!-- ADMIN: SUBJECTS -->
                <div id="view-admin-subjects" class="hidden space-y-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-slate-700 mb-3 border-b pb-2">Global Subjects (All Classes)</h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-s-global" placeholder="Subject Code (e.g. ENG)" class="border rounded-lg p-2 text-sm uppercase flex-1">
                            <button onclick="admin.addGlobalSubject()" class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-bold">Add</button>
                        </div>
                        <div id="list-s-global" class="flex flex-wrap gap-2"></div>
                    </div>
                    <div id="list-s-specific" class="space-y-4"></div>
                </div>

                <!-- ADMIN: REPORTS -->
                <div id="view-admin-reports" class="hidden space-y-4">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-lg mb-2">Reports Center</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                             <div class="space-y-2">
                                 <label class="text-xs font-bold uppercase text-slate-500">Monthly Class Report</label>
                                 <select id="rep-month-cls" class="w-full border rounded p-2 text-sm mb-2"></select>
                                 <input type="month" id="rep-month-date" class="w-full border rounded p-2 text-sm mb-2">
                                 <button onclick="admin.dlMonthly()" class="w-full bg-blue-50 text-blue-600 border border-blue-200 py-2 rounded text-sm font-bold hover:bg-blue-100">Download CSV</button>
                             </div>
                             <div class="space-y-2">
                                 <label class="text-xs font-bold uppercase text-slate-500">Daily Summary (All Classes)</label>
                                 <input type="date" id="rep-day-date" class="w-full border rounded p-2 text-sm mb-2">
                                 <button onclick="admin.dlDaily()" class="w-full bg-green-50 text-green-600 border border-green-200 py-2 rounded text-sm font-bold hover:bg-green-100">Download Summary</button>
                             </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-lg mb-2">Data Management</h3>
                        <div class="flex gap-3">
                             <button onclick="admin.backupData()" class="px-4 py-2 rounded border border-slate-300 text-slate-600 text-sm hover:bg-slate-50">Backup CSV</button>
                             <label class="px-4 py-2 rounded bg-yellow-50 text-yellow-700 text-sm border border-yellow-200 cursor-pointer hover:bg-yellow-100">
                                 Restore CSV <input type="file" class="hidden" onchange="admin.restoreData(this)">
                             </label>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Student Edit Modal -->
    <div id="modal-student" class="fixed inset-0 z-[70] bg-black/40 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <h3 class="font-bold text-lg mb-4" id="modal-student-title">Manage Student</h3>
            <input type="text" id="mod-stu-roll" class="w-full border rounded p-2 mb-2" placeholder="Roll No">
            <input type="text" id="mod-stu-name" class="w-full border rounded p-2 mb-4" placeholder="Name">
            <div class="flex gap-2">
                <button onclick="document.getElementById('modal-student').classList.add('hidden')" class="flex-1 py-2 border rounded text-slate-600">Cancel</button>
                <button onclick="teacher.saveStudent()" class="flex-1 py-2 bg-primary text-white rounded font-bold">Save</button>
            </div>
            <button id="btn-del-student" onclick="teacher.deleteStudent()" class="w-full mt-2 text-red-500 text-xs hover:underline hidden">Delete Student</button>
        </div>
    </div>
    
    <!-- Class Assignment Modal -->
    <div id="modal-assign" class="fixed inset-0 z-[70] bg-black/40 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm flex flex-col max-h-[80vh]">
            <h3 class="font-bold text-lg mb-2">Assign Classes</h3>
            <p class="text-xs text-slate-500 mb-4" id="assign-teacher-name">Select classes for ...</p>
            <div id="assign-checkboxes" class="space-y-2 overflow-y-auto mb-4 border p-2 rounded flex-1"></div>
            <div class="flex gap-2 shrink-0">
                <button onclick="document.getElementById('modal-assign').classList.add('hidden')" class="flex-1 py-2 border rounded text-slate-600">Cancel</button>
                <button onclick="admin.saveAssignments()" class="flex-1 py-2 bg-primary text-white rounded font-bold">Save</button>
            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDrkpeF8kEXw8E6oE7LwgqnfthUFjqNBOQ",
            authDomain: "forteatt-361bc.firebaseapp.com",
            projectId: "forteatt-361bc",
            storageBucket: "forteatt-361bc.firebasestorage.app",
            messagingSenderId: "216222461040",
            appId: "1:216222461040:web:3c4905210b76cb32ed58b5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'forteatt-361bc';

        // --- GLOBAL STATE ---
        window.state = {
            user: null,
            role: null, 
            school: { classes: [], teachers: [], subjects: [], class_subjects: {} },
            currentClass: null,
            students: [],
            attendance: {}, 
            activeSubjects: {}, 
            attendanceMode: 'subject',
            editingStudentIdx: null,
            editingTeacherIdx: null,
            unsubs: []
        };

        // --- UTILS ---
        const toast = (msg) => {
            const el = document.createElement('div');
            el.className = "bg-slate-800 text-white px-4 py-2 rounded-lg shadow-lg text-sm transition-all transform translate-y-0 opacity-0";
            el.innerText = msg;
            document.getElementById('toast-container').appendChild(el);
            requestAnimationFrame(() => el.classList.remove('opacity-0'));
            setTimeout(() => { el.classList.add('opacity-0'); setTimeout(() => el.remove(), 300); }, 3000);
        };

        const saveConfig = async () => {
            if(!auth.currentUser) return;
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'school_data'), window.state.school);
            } catch(e) { console.error(e); toast("Save failed: " + e.message); }
        };

        // --- UI CONTROLLERS ---
        window.ui = {
            setLoginTab: (role) => {
                const isT = role === 'teacher';
                document.getElementById('tab-login-teacher').className = isT ? "flex-1 py-4 text-sm font-semibold text-primary border-b-2 border-primary bg-indigo-50/50 transition-colors" : "flex-1 py-4 text-sm font-medium text-slate-400 hover:text-slate-600 transition-colors";
                document.getElementById('tab-login-admin').className = !isT ? "flex-1 py-4 text-sm font-semibold text-primary border-b-2 border-primary bg-indigo-50/50 transition-colors" : "flex-1 py-4 text-sm font-medium text-slate-400 hover:text-slate-600 transition-colors";
                document.getElementById('form-teacher').classList.toggle('hidden', !isT);
                document.getElementById('form-admin').classList.toggle('hidden', isT);
            },
            switchAdminTab: (tab) => {
                ['dashboard', 'teachers', 'classes', 'subjects', 'reports'].forEach(t => {
                    document.getElementById(`view-admin-${t}`).classList.add('hidden');
                    const nav = document.getElementById(`nav-${t}`);
                    if(nav) nav.className = `w-full text-left px-4 py-3 rounded-lg hover:bg-slate-800 hover:text-white transition flex items-center gap-3 text-slate-400`;
                });
                document.getElementById(`view-admin-${tab}`).classList.remove('hidden');
                document.getElementById(`nav-${tab}`).className = `w-full text-left px-4 py-3 rounded-lg bg-primary text-white transition flex items-center gap-3 shadow-lg shadow-indigo-900/50`;
                
                if(tab === 'dashboard') window.admin.initLive();
            }
        };

        // --- AUTH LOGIC ---
        window.auth = {
            login: async (role) => {
                const email = document.getElementById(`inp-${role}-email`).value.trim();
                const pass = document.getElementById(`inp-${role}-pass`).value.trim();
                if(!email || !pass) return toast("Fill all fields");

                try {
                    await signInWithEmailAndPassword(auth, email, pass);
                    localStorage.setItem('fcs_role_attempt', role); 
                } catch(e) {
                    toast("Login Failed: " + e.code);
                }
            },
            enterClass: () => {
                const cls = document.getElementById('inp-teacher-class').value;
                if(!cls) return;
                localStorage.setItem('fcs_current_class', cls);
                window.state.currentClass = cls;
                window.teacher.init();
            },
            logout: async () => {
                if(confirm("Logout?")) {
                    localStorage.clear();
                    await signOut(auth);
                    location.reload();
                }
            },
            resetPass: async () => {
                const email = document.getElementById('inp-admin-email').value;
                if(email) {
                    await sendPasswordResetEmail(auth, email);
                    toast("Reset link sent!");
                } else toast("Enter admin email first");
            }
        };

        // --- ADMIN CONTROLLER ---
        window.admin = {
            init: () => {
                document.getElementById('view-app').classList.remove('hidden');
                document.getElementById('view-login').classList.add('hidden');
                document.getElementById('admin-sidebar').classList.remove('hidden');
                document.getElementById('admin-sidebar').classList.add('flex');
                document.getElementById('header-title').innerText = "Admin Console";
                document.getElementById('header-subtitle').innerText = "Management";
                
                ui.switchAdminTab('dashboard');
                admin.renderAll();
            },
            renderAll: () => {
                const s = window.state.school;
                if(!s) return;
                
                // Stats
                document.getElementById('stat-t').innerText = s.teachers.length;
                document.getElementById('stat-c').innerText = s.classes.length;
                document.getElementById('stat-s').innerText = s.subjects.length;

                // Lists
                const tList = document.getElementById('list-teachers');
                tList.innerHTML = '';
                s.teachers.forEach((t, i) => {
                    tList.innerHTML += `<div class="bg-white p-3 rounded-lg border border-slate-200">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="font-bold text-slate-800">${t.name}</div>
                                <div class="text-xs text-slate-500">${t.email}</div>
                                <div class="text-[10px] text-indigo-500 mt-1 font-medium">
                                    <i class="fas fa-layer-group mr-1"></i>
                                    ${t.assignedClasses && t.assignedClasses.length > 0 ? t.assignedClasses.join(', ') : 'No classes assigned'}
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="admin.openAssignModal(${i})" class="text-blue-600 text-xs border border-blue-200 px-2 py-1 rounded hover:bg-blue-50">Manage Classes</button>
                                <button onclick="admin.delTeacher(${i})" class="text-red-500 text-xs border border-red-200 px-2 py-1 rounded hover:bg-red-50"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>`;
                });

                const cList = document.getElementById('list-classes');
                cList.innerHTML = '';
                s.classes.forEach((c, i) => {
                    cList.innerHTML += `<div class="bg-white p-3 rounded-lg border border-slate-200 flex justify-between items-center">
                        <span class="font-bold">${c}</span>
                        <div class="flex gap-2">
                             <button onclick="admin.viewClass('${c}')" class="text-xs bg-green-50 text-green-600 px-2 py-1 rounded">View</button>
                             <button onclick="admin.delClass(${i})" class="text-xs text-red-500 px-2 py-1"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
                });
                
                // Dropdowns
                const popSelect = (id) => {
                     const el = document.getElementById(id);
                     if(el) { el.innerHTML = ''; s.classes.forEach(c => el.innerHTML += `<option>${c}</option>`); }
                };
                popSelect('rep-month-cls');
                popSelect('report-class-select'); 
                
                const newTClass = document.getElementById('new-t-class');
                if(newTClass) {
                    newTClass.innerHTML = '<option value="">Primary Class (Optional)</option>';
                    s.classes.forEach(c => newTClass.innerHTML += `<option value="${c}">${c}</option>`);
                }

                // Subjects
                const sgList = document.getElementById('list-s-global');
                sgList.innerHTML = '';
                s.subjects.forEach((sub, i) => {
                    sgList.innerHTML += `<span class="bg-purple-50 text-purple-700 px-2 py-1 rounded text-xs border border-purple-100 flex items-center">${sub} <button onclick="admin.delGlobalSub(${i})" class="ml-2 hover:text-red-500">×</button></span>`;
                });
                
                const ssList = document.getElementById('list-s-specific');
                ssList.innerHTML = '';
                s.classes.forEach(cls => {
                    const specs = s.class_subjects?.[cls] || [];
                    let h = `<div class="bg-white p-3 rounded-lg border border-slate-200 mb-2"><div class="flex justify-between mb-2"><span class="font-bold text-sm">${cls}</span><button onclick="admin.addSpecSub('${cls}')" class="text-xs text-blue-600">+ Add</button></div><div class="flex flex-wrap gap-1">`;
                    if(specs.length===0) h+= `<span class="text-xs text-slate-400">Default Only</span>`;
                    specs.forEach((sub, i) => {
                        h += `<span class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded text-[10px] border border-blue-100 flex items-center">${sub} <button onclick="admin.delSpecSub('${cls}', ${i})" class="ml-1 hover:text-red-500">×</button></span>`;
                    });
                    h += `</div></div>`;
                    ssList.innerHTML += h;
                });
            },
            
            // Actions
            addTeacher: async () => {
                const n = document.getElementById('new-t-name').value;
                const e = document.getElementById('new-t-email').value;
                const p = document.getElementById('new-t-pass').value;
                const c = document.getElementById('new-t-class').value;
                
                if(!n || !e || !p) return toast("Fill all");
                
                try {
                    const tempApp = initializeApp(firebaseConfig, "Secondary");
                    await createUserWithEmailAndPassword(getAuth(tempApp), e, p);
                } catch(err) { return alert(err.message); }

                window.state.school.teachers.push({name:n, email:e, assignedClasses: c ? [c]: []});
                await saveConfig();
                toast("Teacher Created");
                admin.renderAll();
            },
            delTeacher: async (i) => {
                if(confirm("Delete?")) { window.state.school.teachers.splice(i,1); await saveConfig(); admin.renderAll(); }
            },
            
            openAssignModal: (idx) => {
                window.state.editingTeacherIdx = idx;
                const t = window.state.school.teachers[idx];
                document.getElementById('assign-teacher-name').innerText = `Assign classes to: ${t.name}`;
                
                const container = document.getElementById('assign-checkboxes');
                container.innerHTML = '';
                
                window.state.school.classes.forEach(cls => {
                    const isChecked = (t.assignedClasses || []).includes(cls) ? 'checked' : '';
                    container.innerHTML += `
                        <label class="flex items-center p-2 hover:bg-slate-50 rounded cursor-pointer border border-transparent hover:border-slate-100">
                            <input type="checkbox" class="class-assign-cb rounded text-primary focus:ring-primary mr-3" value="${cls}" ${isChecked}>
                            <span class="text-sm text-slate-700 font-medium">${cls}</span>
                        </label>
                    `;
                });
                
                document.getElementById('modal-assign').classList.remove('hidden');
            },
            
            saveAssignments: async () => {
                if (window.state.editingTeacherIdx === null) return;
                
                const checkboxes = document.querySelectorAll('.class-assign-cb:checked');
                const selected = Array.from(checkboxes).map(cb => cb.value);
                
                window.state.school.teachers[window.state.editingTeacherIdx].assignedClasses = selected;
                await saveConfig();
                
                document.getElementById('modal-assign').classList.add('hidden');
                admin.renderAll();
                toast("Classes Assigned!");
            },
            
            addClass: async () => {
                const n = document.getElementById('new-c-name').value.toUpperCase();
                if(n && !window.state.school.classes.includes(n)) {
                    window.state.school.classes.push(n);
                    await saveConfig();
                    document.getElementById('new-c-name').value = '';
                    admin.renderAll();
                }
            },
            delClass: async (i) => {
                if(confirm("Delete Class?")) { window.state.school.classes.splice(i,1); await saveConfig(); admin.renderAll(); }
            },
            addGlobalSub: async () => {
                const s = document.getElementById('new-s-global').value.toUpperCase();
                if(s && !window.state.school.subjects.includes(s)) {
                    window.state.school.subjects.push(s);
                    await saveConfig();
                    document.getElementById('new-s-global').value = '';
                    admin.renderAll();
                }
            },
            delGlobalSub: async (i) => {
                if(confirm("Delete?")) { window.state.school.subjects.splice(i,1); await saveConfig(); admin.renderAll(); }
            },
            addSpecSub: async (cls) => {
                const s = prompt("Subject Code:");
                if(s) {
                    const up = s.toUpperCase();
                    if(!window.state.school.class_subjects) window.state.school.class_subjects = {};
                    if(!window.state.school.class_subjects[cls]) window.state.school.class_subjects[cls] = [];
                    if(!window.state.school.class_subjects[cls].includes(up)) {
                        window.state.school.class_subjects[cls].push(up);
                        await saveConfig();
                        admin.renderAll();
                    }
                }
            },
            delSpecSub: async (cls, i) => {
                window.state.school.class_subjects[cls].splice(i,1);
                await saveConfig();
                admin.renderAll();
            },
            
            initLive: () => {
                const tbody = document.getElementById('live-table-body');
                const d = document.getElementById('live-date').value || new Date().toISOString().split('T')[0];
                if (document.getElementById('live-date').value === '') document.getElementById('live-date').value = d;
                
                // Clear entire table first - IMPORTANT: This resets the DOM completely
                tbody.innerHTML = '';
                
                window.state.school.classes.forEach(cls => {
                    const rid = `live-${cls.replace(/\s+/g, '-')}`;
                    // Create row element properly instead of innerHTML += which kills listeners
                    const tr = document.createElement('tr');
                    tr.id = rid;
                    tr.className = "border-b border-slate-50";
                    tr.innerHTML = `<td class="px-6 py-3 font-bold">${cls}</td><td class="text-center">-</td><td class="text-center">-</td><td class="text-center">-</td><td class="text-center">-</td>`;
                    tbody.appendChild(tr);

                    const unsub = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', `${cls}_${d}`), snap => {
                         const el = document.getElementById(rid);
                         if(!el) return;
                         
                         if(snap.exists()) {
                             const recs = snap.data().records;
                             let p=0, a=0, l=0, sl=0;
                             Object.values(recs).forEach(r => {
                                 const vals = Object.values(r);
                                 if(vals.includes('P')) p++;
                                 else if(vals.includes('L')) l++;
                                 else if(vals.includes('A')) a++;
                                 else if(vals.includes('S/L')) sl++;
                             });
                             el.innerHTML = `<td class="px-6 py-3 font-bold">${cls}</td><td class="text-center text-green-600 font-bold">${p}</td><td class="text-center text-red-600 font-bold">${a}</td><td class="text-center text-yellow-600 font-bold">${l}</td><td class="text-center text-orange-500 font-bold">${sl}</td>`;
                         } else {
                             el.innerHTML = `<td class="px-6 py-3 font-bold">${cls}</td><td colspan="4" class="text-center text-xs text-slate-400">Pending</td>`;
                         }
                    });
                    
                    // Track unsub to clear later
                    window.state.unsubs.push(unsub);
                });
            },
            viewClass: (cls) => {
                window.state.currentClass = cls;
                document.getElementById('view-app').classList.remove('hidden');
                document.getElementById('view-login').classList.add('hidden');
                document.getElementById('admin-sidebar').classList.add('hidden'); 
                document.getElementById('header-title').innerText = cls;
                document.getElementById('header-subtitle').innerText = "Admin View Mode";
                window.teacher.init(); 
            },
            
            // DOWNLOADS
            dlMonthly: async () => {
                const cls = document.getElementById('rep-month-cls').value;
                const m = document.getElementById('rep-month-date').value;
                if(!cls || !m) return alert("Select Class & Month");
                
                const [y, mm] = m.split('-');
                const days = new Date(y, mm, 0).getDate();
                
                let csv = "Roll,Name,Total Lectures,Attended (P),Absents (A),Leaves (L),Short Leaves (S/L)\n";
                
                const cSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'classes', cls));
                const stus = cSnap.exists() ? cSnap.data().students : [];
                
                const atts = {};
                await Promise.all(Array.from({length:days}, (_,i) => {
                    const d = `${y}-${mm}-${String(i+1).padStart(2,'0')}`;
                    return getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', `${cls}_${d}`))
                        .then(s => atts[d] = s.exists() ? s.data().records : {});
                }));
                
                stus.forEach(s => {
                    let totalP=0, totalA=0, totalL=0, totalSL=0, totalLec=0;
                    
                    for(let i=1; i<=days; i++) {
                        const d = `${y}-${mm}-${String(i+1).padStart(2,'0')}`;
                        const rec = atts[d]?.[s.id];
                        if(rec) {
                            Object.values(rec).forEach(val => {
                                if(val !== '-') totalLec++; 
                                if(val === 'P') totalP++;
                                else if(val === 'A') totalA++;
                                else if(val === 'L') totalL++;
                                else if(val === 'S/L') totalSL++;
                            });
                        }
                    }
                    csv += `"${s.rollNo}","${s.name}",${totalLec},${totalP},${totalA},${totalL},${totalSL}\n`;
                });
                
                const b = new Blob([csv], {type:'text/csv'});
                const u = URL.createObjectURL(b);
                const a = document.createElement('a'); a.href=u; a.download=`${cls}_${m}_Report.csv`; a.click();
            },
            
            dlDaily: async () => {
                alert("Generating...");
            },
            
            backupData: async () => {
                 const data = JSON.stringify(window.state.school);
                 const b = new Blob([data], {type:'json'});
                 const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download='school_backup.json'; a.click();
            },
            restoreData: (input) => {
                const f = input.files[0];
                if(!f) return;
                const r = new FileReader();
                r.onload = async (e) => {
                    const d = JSON.parse(e.target.result);
                    window.state.school = d;
                    await saveConfig();
                    alert("Restored!");
                    location.reload();
                };
                r.readAsText(f);
            }

        };

        // --- TEACHER CONTROLLER ---
        window.teacher = {
            init: () => {
                document.getElementById('view-app').classList.remove('hidden');
                document.getElementById('view-login').classList.add('hidden');
                document.getElementById('view-teacher-attendance').classList.remove('hidden');
                document.getElementById('header-title').innerText = window.state.currentClass;
                const d = new Date().toISOString().split('T')[0];
                document.getElementById('att-date').value = d;
                
                onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'classes', window.state.currentClass), snap => {
                    window.state.students = snap.exists() ? (snap.data().students || []) : [];
                    teacher.renderList();
                });
                teacher.loadData();
            },
            
            loadData: () => {
                const d = document.getElementById('att-date').value;
                const glob = window.state.school.subjects || [];
                const spec = window.state.school.class_subjects?.[window.state.currentClass] || [];
                const subs = Array.from(new Set([...glob, ...spec]));
                
                const filter = document.getElementById('att-subjects-filter');
                filter.innerHTML = '';
                subs.forEach(s => {
                    if(window.state.activeSubjects[s] === undefined) window.state.activeSubjects[s] = true;
                    const active = window.state.activeSubjects[s];
                    filter.innerHTML += `<button onclick="teacher.toggleSub('${s}')" class="px-3 py-1 rounded-full text-xs font-bold border transition ${active ? 'bg-indigo-100 text-indigo-700 border-indigo-200' : 'bg-slate-100 text-slate-400 border-slate-200'}">${s}</button>`;
                });
                
                if(window.state.dailyUnsub) window.state.dailyUnsub();
                window.state.dailyUnsub = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', `${window.state.currentClass}_${d}`), snap => {
                    window.state.attendance = snap.exists() ? snap.data().records : {};
                    teacher.renderList();
                });
            },
            
            toggleSub: (s) => {
                window.state.activeSubjects[s] = !window.state.activeSubjects[s];
                teacher.loadData(); 
            },
            
            setRowStatus: (sid, status) => {
                if(!window.state.attendance[sid]) window.state.attendance[sid] = {};
                const glob = window.state.school.subjects || [];
                const spec = window.state.school.class_subjects?.[window.state.currentClass] || [];
                const subs = Array.from(new Set([...glob, ...spec]));
                subs.forEach(sub => {
                    if (window.state.activeSubjects[sub] !== false) window.state.attendance[sid][sub] = status;
                });
                teacher.renderList();
            },

            renderList: () => {
                const list = document.getElementById('att-list');
                const thead = document.getElementById('att-thead');
                const search = document.getElementById('att-search').value.toLowerCase();
                document.getElementById('student-count').innerText = `${window.state.students.length} Students`;
                
                const glob = window.state.school.subjects || [];
                const spec = window.state.school.class_subjects?.[window.state.currentClass] || [];
                const subs = Array.from(new Set([...glob, ...spec]));
                const activeSubs = subs.filter(s => window.state.activeSubjects[s] !== false);
                
                let headerHTML = `<tr><th class="px-4 py-3 w-16 text-center sticky-col-1 bg-slate-100 border-b border-r border-slate-200 shadow-sm">Roll</th><th class="px-4 py-3 w-40 sticky-col-2 bg-slate-100 border-b border-r border-slate-200 shadow-sm">Name <span class="text-[10px] text-slate-400 font-normal">(Actions)</span></th>`;
                activeSubs.forEach(sub => { headerHTML += `<th class="px-4 py-3 text-center min-w-[160px] border-b border-slate-200">${sub}</th>`; });
                headerHTML += `</tr>`;
                thead.innerHTML = headerHTML;
                list.innerHTML = '';
                
                const getBtnClass = (val, current) => {
                    let base = "flex-1 py-1.5 text-[10px] font-bold border-r last:border-r-0 border-slate-200 transition-colors first:rounded-l last:rounded-r";
                    if (val !== current) return base + " text-slate-400 bg-white hover:bg-slate-50";
                    if (val === 'P') return base + " bg-green-500 text-white";
                    if (val === 'A') return base + " bg-red-500 text-white";
                    if (val === 'L') return base + " bg-yellow-500 text-white";
                    if (val === 'S/L') return base + " bg-orange-500 text-white";
                };

                window.state.students
                    .filter(s => s.name.toLowerCase().includes(search) || s.rollNo.includes(search))
                    .sort((a,b) => a.rollNo.localeCompare(b.rollNo, undefined, {numeric:true}))
                    .forEach((s, idx) => {
                        let row = `<tr class="hover:bg-slate-50 transition-colors border-b border-slate-50">
                            <td class="px-4 py-3 font-mono text-slate-600 font-bold text-center sticky-col-1 bg-white group-hover:bg-slate-50 border-r border-slate-100 shadow-sm">${s.rollNo}</td>
                            <td class="px-4 py-3 font-medium text-slate-800 sticky-col-2 bg-white group-hover:bg-slate-50 border-r border-slate-100 shadow-sm cursor-pointer whitespace-nowrap">
                                <div class="flex justify-between items-center">
                                    <span onclick="teacher.editStudent(${idx})">${s.name}</span>
                                    <div class="flex gap-1 ml-2">
                                        <button onclick="teacher.setRowStatus('${s.id}', 'P')" class="text-[10px] bg-green-50 text-green-600 px-1.5 py-0.5 rounded border border-green-200 hover:bg-green-100" title="All P">P</button>
                                        <button onclick="teacher.setRowStatus('${s.id}', 'A')" class="text-[10px] bg-red-50 text-red-600 px-1.5 py-0.5 rounded border border-red-200 hover:bg-red-100" title="All A">A</button>
                                    </div>
                                </div>
                            </td>`;
                        const rec = window.state.attendance[s.id] || {};
                        activeSubs.forEach(sub => {
                            const status = rec[sub] || 'P'; 
                            row += `<td class="px-4 py-2 text-center"><div class="flex border border-slate-200 rounded w-full max-w-[180px] mx-auto shadow-sm">
                                <button onclick="teacher.setStatus('${s.id}', '${sub}', 'P')" class="${getBtnClass('P', status)}">P</button>
                                <button onclick="teacher.setStatus('${s.id}', '${sub}', 'A')" class="${getBtnClass('A', status)}">A</button>
                                <button onclick="teacher.setStatus('${s.id}', '${sub}', 'L')" class="${getBtnClass('L', status)}">L</button>
                                <button onclick="teacher.setStatus('${s.id}', '${sub}', 'S/L')" class="${getBtnClass('S/L', status)}">SL</button>
                            </div></td>`;
                        });
                        row += `</tr>`;
                        list.innerHTML += row;
                    });
            },
            
            setStatus: (sid, key, status) => {
                if(!window.state.attendance[sid]) window.state.attendance[sid] = {};
                window.state.attendance[sid][key] = status;
                teacher.renderList();
            },
            
            save: async () => {
                const d = document.getElementById('att-date').value;
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'attendance', `${window.state.currentClass}_${d}`);
                const finalData = JSON.parse(JSON.stringify(window.state.attendance)); 
                const glob = window.state.school.subjects || [];
                const spec = window.state.school.class_subjects?.[window.state.currentClass] || [];
                const subs = Array.from(new Set([...glob, ...spec]));
                
                window.state.students.forEach(s => {
                    if(!finalData[s.id]) finalData[s.id] = {};
                    subs.forEach(sub => {
                        if(window.state.activeSubjects[sub] !== false) {
                            if(!finalData[s.id][sub]) finalData[s.id][sub] = 'P';
                        } else {
                            finalData[s.id][sub] = '-';
                        }
                    });
                });
                
                await setDoc(ref, { date: d, records: finalData });
                toast("Attendance Saved!");
            },
            
            filter: () => teacher.renderList(),
            
            openAddStudentModal: () => {
                window.state.editingStudentIdx = null;
                document.getElementById('modal-student-title').innerText = "Add Student";
                document.getElementById('mod-stu-roll').value = "";
                document.getElementById('mod-stu-name').value = "";
                document.getElementById('btn-del-student').classList.add('hidden');
                document.getElementById('modal-student').classList.remove('hidden');
            },

            editStudent: (idx) => {
                window.state.editingStudentIdx = idx;
                const s = window.state.students[idx];
                document.getElementById('modal-student-title').innerText = "Edit Student";
                document.getElementById('mod-stu-roll').value = s.rollNo;
                document.getElementById('mod-stu-name').value = s.name;
                document.getElementById('btn-del-student').classList.remove('hidden');
                document.getElementById('modal-student').classList.remove('hidden');
            },

            saveStudent: async () => {
                const r = document.getElementById('mod-stu-roll').value;
                const n = document.getElementById('mod-stu-name').value;
                if(!r || !n) return alert("Fill all fields");
                if (window.state.editingStudentIdx !== null) {
                    window.state.students[window.state.editingStudentIdx].rollNo = r;
                    window.state.students[window.state.editingStudentIdx].name = n;
                } else {
                    window.state.students.push({id: Date.now().toString(), rollNo: r, name: n});
                }
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'classes', window.state.currentClass), {students: window.state.students}, {merge:true});
                document.getElementById('modal-student').classList.add('hidden');
                teacher.renderList();
                toast(window.state.editingStudentIdx !== null ? "Updated" : "Added");
            },

            deleteStudent: async () => {
                if(confirm("Delete student?")) {
                    window.state.students.splice(window.state.editingStudentIdx, 1);
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'classes', window.state.currentClass), {students: window.state.students}, {merge:true});
                    document.getElementById('modal-student').classList.add('hidden');
                    teacher.renderList();
                }
            },

            importFile: (input) => {
                const f = input.files[0];
                if(!f) return;
                const r = new FileReader();
                r.onload = async (e) => {
                    const lines = e.target.result.split('\n');
                    let count = 0;
                    lines.forEach(l => {
                        const [roll, name] = l.split(',');
                        if(roll && name) {
                            window.state.students.push({id: Date.now()+Math.random().toString(), rollNo: roll.trim(), name: name.trim()});
                            count++;
                        }
                    });
                    if(count > 0) {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'classes', window.state.currentClass), {students: window.state.students}, {merge:true});
                        teacher.renderList();
                        toast(`Imported ${count} students`);
                    }
                    input.value = '';
                };
                r.readAsText(f);
            }
        };

        // --- BOOTSTRAP ---
        onAuthStateChanged(auth, (user) => {
            window.state.user = user;
            if (user) {
                onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'school_data'), (snap) => {
                    if(snap.exists()) {
                        window.state.school = snap.data();
                        const role = localStorage.getItem('fcs_role_attempt');
                        if(role === 'admin') {
                            admin.init();
                        } else if (localStorage.getItem('fcs_current_class')) {
                            window.state.currentClass = localStorage.getItem('fcs_current_class');
                            teacher.init();
                        } else {
                             const teacherData = window.state.school.teachers.find(t => t.email.toLowerCase() === user.email.toLowerCase());
                             if(teacherData) {
                                 const sel = document.getElementById('inp-teacher-class');
                                 sel.innerHTML = '';
                                 teacherData.assignedClasses.forEach(c => sel.innerHTML += `<option>${c}</option>`);
                                 document.getElementById('teacher-class-select-wrapper').classList.remove('hidden');
                                 document.getElementById('btn-teacher-login').classList.add('hidden');
                                 document.getElementById('inp-teacher-email').disabled = true;
                                 document.getElementById('inp-teacher-pass').disabled = true;
                             }
                        }
                    } else {
                        setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'school_data'), window.state.school);
                    }
                });
            } else {
                document.getElementById('view-login').classList.remove('hidden');
                document.getElementById('view-app').classList.add('hidden');
            }
        });
    </script>
</body>
</html>
